<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결과 페이지</title>
    <link rel="stylesheet" href="/static/result.css">
</head>
<body>
<header>
    <h1>예상 경비 시뮬레이터</h1>
</header>
<main>
    <div id="result-container">
        <h2>최종 경비</h2>
        <div id="selected-items">
            <h3>선택한 것들 각각의 가격</h3>
            <ul id="selected-list"></ul>
        </div>
        <div id="total-cost">
            <h3>합계 금액</h3>
            <p id="total-cost-value">0원</p>
        </div>
    </div>
</main>
<footer>
    <div id="button-container">
        <button onclick="goBack()">다시 분석하기</button>
        <button onclick="saveResult()">내 정보에 저장</button>
    </div>
</footer>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const selectedPlaces = JSON.parse(localStorage.getItem('selectedPlaces')) || [];
        const selectedList = document.getElementById('selected-list');
        const totalCostValue = document.getElementById('total-cost-value');



        let totalCost = 0;
        let placeNames = [];
        selectedPlaces.forEach(place => {
            const listItem = document.createElement('li');
            listItem.textContent = `${place.name} (${place.type}) - ${place.price}원`;
            selectedList.appendChild(listItem);

            totalCost += place.price;
            placeNames.push(place.name);
        });

        totalCostValue.textContent = `${totalCost}원`;
    });

    function goBack() {
        localStorage.removeItem('selectedPlaces');
        window.location.href = "/simulator/reset";
    }


    // 시뮬레이션 결과 db에 저장
    function saveResult() {
        const selectedList = document.getElementById('selected-list');
        const placeNames = Array.from(selectedList.querySelectorAll('li')).map(li => {
            // 괄호와 괄호 뒤의 모든 내용을 제거하고 앞뒤 공백을 제거
            return li.textContent
                .replace(/\(.*$/, '')  // 괄호 및 괄호 뒤의 모든 내용 제거
                .trim();  // 앞뒤 공백 제거
        });
        const totalCost = document.getElementById('total-cost-value').textContent.replace('원', '');
        const resultSaveRequest = {
            totalPrice: totalCost,
            places: placeNames
        };

        fetch('api/result', {
            method: 'POST',
            headers: {
                'Content-Type' : 'application/json'
            },
            body: JSON.stringify(resultSaveRequest)
        })
            .then(response => {
                if(!response.ok) {
                    // alert('로그인이후에 이용해주세요.');
                    // console.log('Navigating to: /Rdatabase/login');
                    window.location.href = '/Rdatabase/login';
                    return;
                }
                alert('결과가 저장되었습니다.');
            })
            .catch(error => {
                console.error(error);
            });
    }

</script>
</body>
</html>
